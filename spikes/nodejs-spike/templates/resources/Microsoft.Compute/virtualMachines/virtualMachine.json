{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "source": { "type": "object" }
  },
  "variables": {
  },
  "resources": [
    {
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2017-03-01",
      "name": "[parameters('source').name]",
      "location": "[resourceGroup().location]",
      "tags": { "displayName": "VM" },
      "properties": {
        "availabilitySet": "[parameters('source').availabilitySet]",
        "hardwareProfile": { "vmSize": "[parameters('source').size]" },
        "osProfile": {
          "computerName": "[parameters('source').computerName]",
          "adminUsername": "[parameters('source').adminUsername]",
          "adminPassword": "[parameters('source').adminPassword]",
          "[concat(toLower(parameters('source').osType), 'Configuration')]": "[parameters('source')[concat(toLower(parameters('source').osType), 'Configuration')]]"
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "[parameters('source').imageReference.publisher]",
            "offer": "[parameters('source').imageReference.offer]",
            "sku": "[parameters('source').imageReference.sku]",
            "version": "[parameters('source').imageReference.version]"
          },
          "osDisk": "[parameters('source').osDisk]",
          "dataDisks": "[parameters('source').dataDisks]"
        },
        "networkProfile": {
          "networkInterfaces": "[parameters('source').nics]"
        },
        "diagnosticsProfile": "[parameters('source').diagnosticsProfile]"
      }
    }
  ]
}
